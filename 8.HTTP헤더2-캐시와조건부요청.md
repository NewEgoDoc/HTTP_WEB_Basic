그럼 이제 먼저 캐시가 어떻게 동작하는지에 대해서 먼저 설명해드릴게요

자 여러분 먼저 캐시가 없어요

예를 들어서 여러분이 웹 브라우저에서 star.jpg를 요청한다고 가정하겠습니다

서버에서 별과 관련된 그림을 내려주는 거죠

star.jpg를 딱 요청을 하면 처음에 어떻게 되겠습니까?

서버에서 보고 star.jpg가 있으면 응답을 내려 주겠죠?

자 근데 이렇게 가정을 할거에요 응답 http 이거를 보시면요

이 헤더가 있고

실제 이미지와 관련된 바이트 코드들이 있는거죠

자 그렇다고 할때

이 이미지가 http 헤더의 용량이 0.1 메가
이 http 바디에 해당하는 부분이 1.0 메가

이런식으로 된다면 

1.1메가 가 전송

이렇게되면 이미지가 딱 웹브라우저에 표시가 되겠죠?

자 캐시가 없을 때 웹 브라우저가 똑같은 요청을 한번 더해요

캐시가 없을 때
• 데이터가 변경되지 않아도 계속 네트워크를 통해서 데이터를 다운로드 받아야 한다.
• 인터넷 네트워크는 매우 느리고 비싸다.
• 브라우저 로딩 속도가 느리다.
• 느린 사용자 경험

자 그래서 캐시를 적용해 보겠습니다

캐시를 적용하면 어떻게 되냐면

cache-control이라고 헤더에 넣어 줄수가 있어요

캐시가 유효한 시간이에요

max-age 가 60이라고 하면 60초 동안 이제 이 응답이 내려가면서 60초동안은 캐시가 유효하다는 뜻이에요

자 그렇게 되면 일단 최초로 요청을 할때는 

star.jpg가 일단 내려가요

그럼 어떻게 되느냐

자 여러분 웹브라우저에는 내부에 캐시를 저장하는 저장소가 있거든요?

자 여기에다가 이렇게 합니다

cache-control이 최대시간이 60초였죠?

응답결과를 캐시에 저장합니다

자 이렇게 되면 두번째 요청할때는 캐시를 뒤져요
 60초 유효하고 내가 아직 60초 안에 있어요

 그럼 그냥 캐시에서 바로 가져오는 거에요

 네트웍을 아예 탈 필요가 없는거죠

자 그래서 여러분 캐시 덕분에

 캐시 적용
• 캐시 덕분에 캐시 가능 시간동안 네트워크를 사용하지 않아도 된다.
• 비싼 네트워크 사용량을 줄일 수 있다.
• 브라우저 로딩 속도가 매우 빠르다.
• 빠른 사용자 경험

그래서 여러분 대부분 웹브라우저 같은 거 한번 들어갔다가 나와서 다시 들어가면 되게 빨리 열리거든요?

그게 이 캐시가 적용되어있어서 그렇습니다

그런데 이제이... 3번째 요청을 해볼게요

만약에 max-age인 60초를 초과했다면?

당연히 다시 요청을 해야 됩니다.

캐시 시간 초과
• 캐시 유효 시간이 초과하면, 서버를 통해 데이터를 다시 조회하고, 캐시를 갱신한다.
• 이때 다시 네트워크 다운로드가 발생한다.

그런데 여러분 방금 상황을 잘 생각해보면
여기보면 이미지가 별이 과연 바뀌었을까요 안바뀌었을 까요

이미지가 전혀 안변했어요
그런데 전체를 다시 다 다운로드를 받는다?
이거는 이제 뭔가 아까운거죠

만약에 캐시가 이제 만료가 되었어요(60초가 지났어요)
그래도 서버가 가진 데이터랑 클라이언트가 가진 데이터랑 만약에 똑같애요 
그런데도 1메가나 되는 이파일을 다시 다운받을 필요가 있을까요?

이거를 해결할수 있는 메커니즘을 다음시간에 설명을 드리겠습니다

# 검증 헤더와 조건부 요청1

캐시 시간 초과
• 캐시 유효 시간이 초과해서 서버에 다시 요청하면 다음 두 가지 상황이 나타난다.
1. 서버에서 기존 데이터를 변경함
2. 서버에서 기존 데이터를 변경하지 않음

다음 두가지 상황이 나와요 60초 지나서 다시 요청해야지라고 했는데 
다시 요청을 해봐요? 클라이언트에서 서버로.. 서버에서 진짜 노란별을 초록별로 바꿔 버린거에요 자 그렇게 되면 이건 진짜 데이터가 바뀐거죠?
그러니까 새로운 요 초록색깔 별을 다운로드 받아서 다시 캐시를 갱신하거나 이렇게 고객한테 보여주는게 맞아요
그런데 만약에 60초가 초과했는데 다시 요청을 해봤어요 클라이언트에서 서버로 그런데 기존이랑 똑같은 별을 처음부터 다시 다 다운받는 거에요 자 이렇게 되면 이거 용량이 1M나 되는데 처음부터 다시 다 다운받아야 할까라는 의문이 드는거에요

그래서 그걸해결하는게 검증헤더 

검증헤더와 조건부 요청입니다

캐시 시간 초과
• 캐시 만료후에도 서버에서 데이터를 변경하지 않음
• 생각해보면 데이터를 전송하는 대신에 저장해 두었던 캐시를 재사용 할 수 있다.
• 단 클라이언트의 데이터와 서버의 데이터가 같다는 사실을 확인할 수 있는 방법 필요

캐시 만료후에 서버에게 요청을 했는데 알고보니 서버에서 데이터를 안바꾼거에요

여러분 여기서 잘 생각을 해보면 여기서 1M짜리 무거운 별을 전부다 전송하는 대신에 저장해 두었던 로컬 캐시를 다시 쓸 수가 있어요

왜냐면 데이터가 안변했기 때문에

그런데 클라이언트에 있는 캐시데이터랑 서버에 들어있는 캐시데이터가 안바뀌었다는 사실을 확인할수 있는 방법이 필요합니다

자 이제 그래서 이 검증헤더라는게 들어갑니다.

처음부터!
star.jpg 요청을 보내요 캐시 컨트롤은 말씀 드렸죠? Last-Modified라는 걸 추가 할수 있습니다 이게 뭐냐면

이 데이터가 마지막으로 수정된 시간이에요

참고로 UTC 표기법으로 적어야합니다

응답결과를 당연히 캐시데이터에 저장하구요
60초 유효하다는 것도 적어 놓구요
데이터 최종 수정일은 
2020년 11월 10일 10시다

60초 안이면 이 캐시를 쓰겠죠?
60초가 넘어간거에요
자~ 60초가 지나면 이 검증 헤더가 있거든요

넘었으니까 다시 요청을 보냅니다

웹브라우저가 서버에 요청을 보낼때

If-modified-since http 요청헤더를 붙인다음에 UTC 시간 값을 서버에 넘깁니다

서버에서는 요청이 왔는데 If-modified-since가 왔네? 그럼 서버에서 나 star.jpg가 있는데 2020년 11월 10일 10시이야'

쟤가 요청보낸거랑 내가 가진 파일이랑 비교해서 검증을 할 수가 있는거에요

보니까 어? 날짜가 똑같아요

서버는 날짜를 보고 판단하죠

어? 너 날짜를 보니까 니꺼는 아직 써도 돼!
아직 신선하네 라고 판단을 할수가 있는거죠

그럼 어떻게 하느냐

서버에서 딱 보고 수정이 안됬네 하면

Http 응답을 만들때

304 Not Modified라고 내 보내요 이게 뭐냐면
니가 요청했는데 나 변경한게 없어라고 보내고요

그 다음에 이렇게 합니다
캐시 컨트롤 그대로 가고요

Last Modified 그냥 내보냅니다
근데 여러분 중요한게 있어요
Http바디가 없어요

자 무슨말이야 

Http 요청헤더가 
대략 .1이라고 가정해보고요 

바디부가 이데이터에 대한게 1M가라고 한다면 Body부를 떼버리는 거에요 

수정된게 없기 때문에 

자그럼 기존에는 우리가 1.1M를 응답했잖아요?
이그런데 이제는 헤더부분만 남기고 Body부분을 지운채로 보내는 거에요

그럼 네트워크 부하가 확 줄겠죠?
자 그렇게해서 응답을 합니다

자 그렇게 하면 

딱 받았을 때 304 Not Modified네?
자 이거는 캐시 안바뀌었으니까 써도 되네 라고 인식을 하구요

캐시 컨트롤 값 갱신하고 last modified 값은 갱신 하건 안하건 브라우저가 알아서 하겠죠?

자 캐시를 다시 세팅을 하고 다시 가져와서 쓰게 됩니다

검증 헤더와 조건부 요청
정리

자 정리를 해보면요 검증헤더랑 조건부 요청을 같이 쓴거에요
검증헤더가 뭐냐면 라스트 모디파이드 이게 이제 검증 할 수 있는 값이죠?

If-modified-since 이게 만약? 만약 모디파이디드 신스 이때로 부터 바뀌었으면 

그래서 이거를 조건부 요청이라고 합니다

이 캐시가 진짜로 갱신이 되었는지 안되었는지를 이거를 한번 맞춰볼수 있는거에요

이렇게하면 쓸데없는데 용량을 확 줄일 수 있겠죠?

그리고 브라우저는 로컬에 들고 있는 캐시를 재사용할수 있겠죠

• 캐시 유효 시간이 초과해도, 서버의 데이터가 갱신되지 않으면
• 304 Not Modified + 헤더 메타 정보만 응답(바디X)

자 이렇게 되면 

• 클라이언트는 서버가 보낸 응답 헤더 정보로 캐시의 메타 정보를 갱신
• 클라이언트는 캐시에 저장되어 있는 데이터 재활용

자 여러분

• 결과적으로 네트워크 다운로드가 발생하지만 용량이 적은 헤더 정보만 다운로드

0.1M만 헤더값만 다운로드 받으면 되는거죠?

• 매우 실용적인 해결책

자 그래서 웹 브라우저들은 대부분 이 메커니즘을 다 실행하고 있습니다

자 보세요 status에 연한게 캐시에서 불러온거에요

jpg 중에 아무거나해서 요청을 보내면 새로고침으로 연거에요

그렇게하면 보세요 상태코드 304로 나오죠?

If modified since라고 보일 겁니다